name: Build Frida 16.7.19 with Full Florida Patches

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        
    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential gcc-multilib g++-multilib libc6-dev
        pip install lief
        
    - name: Clone Frida 16.7.19
      run: |
        git clone --branch 16.7.19 --recurse-submodules --depth 1 https://github.com/frida/frida.git
        
    - name: Apply Florida Patches - frida-core
      run: |
        cd frida/subprojects/frida-core
        
        # ===== Patch 1: string_frida_rpc (lib/base/rpc.vala) =====
        echo "[*] Applying patch 1: string_frida_rpc"
        python3 << 'PATCH1'
import re

filepath = "lib/base/rpc.vala"
with open(filepath, "r") as f:
    content = f.read()

# Add getRpcStr method after the constructor
constructor_pattern = r'(Object \(peer: peer\);\s*\})'
getRpcStr_method = '''Object (peer: peer);
		}

		public string getRpcStr(bool quote){
			string result = (string) GLib.Base64.decode((string) GLib.Base64.decode("Wm5KcFpHRTZjbkJq"));
			if(quote){
				return "\\"" + result + "\\"";
			}else{
				return result;
			}
		'''
content = re.sub(constructor_pattern, getRpcStr_method, content)

# Replace "frida:rpc" with getRpcStr(false)
content = content.replace('.add_string_value ("frida:rpc")', '.add_string_value (getRpcStr(false))')

# Replace "\"frida:rpc\"" check with getRpcStr(true)
content = content.replace('json.index_of ("\\"frida:rpc\\"")', 'json.index_of (getRpcStr(true))')

# Replace type != "frida:rpc" with getRpcStr(false)
content = content.replace('type != "frida:rpc"', 'type != getRpcStr(false)')

with open(filepath, "w") as f:
    f.write(content)
print("  Patch 1 applied")
PATCH1

        # ===== Patch 2: frida_agent_so (src/linux/linux-host-session.vala) =====
        echo "[*] Applying patch 2: frida_agent_so"
        python3 << 'PATCH2'
filepath = "src/linux/linux-host-session.vala"
with open(filepath, "r") as f:
    content = f.read()

# Find the agent descriptor section and add random prefix
old_pattern = 'agent = new AgentDescriptor (PathTemplate ("frida-agent-<arch>.so"),'
new_pattern = '''var random_prefix = GLib.Uuid.string_random();
			agent = new AgentDescriptor (PathTemplate (random_prefix + "-<arch>.so"),'''
content = content.replace(old_pattern, new_pattern)

# Replace frida-agent-arm.so
content = content.replace('new AgentResource ("frida-agent-arm.so",', 'new AgentResource (random_prefix + "-arm.so",')
content = content.replace('new AgentResource ("frida-agent-arm64.so",', 'new AgentResource (random_prefix + "-arm64.so",')

with open(filepath, "w") as f:
    f.write(content)
print("  Patch 2 applied")
PATCH2

        # ===== Patch 3: symbol_frida_agent_main =====
        echo "[*] Applying patch 3: symbol_frida_agent_main"
        # Replace frida_agent_main with main in multiple files
        sed -i 's/frida_agent_main/main/g' src/agent-container.vala
        sed -i 's/frida_agent_main/main/g' src/linux/linux-host-session.vala
        sed -i 's/frida_agent_main/main/g' src/darwin/darwin-host-session.vala || true
        sed -i 's/frida_agent_main/main/g' src/freebsd/freebsd-host-session.vala || true
        sed -i 's/frida_agent_main/main/g' src/qnx/qnx-host-session.vala || true
        sed -i 's/frida_agent_main/main/g' src/windows/windows-host-session.vala || true
        echo "  Patch 3 applied"
        
        # ===== Patch 6: protocol_unexpected_command =====
        echo "[*] Applying patch 6: protocol_unexpected_command"
        sed -i 's/throw new Error.PROTOCOL ("Unexpected command");/break; \/\/ throw new Error.PROTOCOL ("Unexpected command");/g' src/droidy/droidy-client.vala
        echo "  Patch 6 applied"
        
        # ===== Patch 8: pool-frida (frida-glue.c) =====
        echo "[*] Applying patch 8: pool-frida in frida-glue.c"
        python3 << 'PATCH8'
filepath = "src/frida-glue.c"
with open(filepath, "r") as f:
    content = f.read()

# Add g_set_prgname after g_io_module_openssl_register
old = 'g_io_module_openssl_register ();'
new = '''g_io_module_openssl_register ();
#endif

    g_set_prgname ("ggbond");

    if (runtime == FRIDA_RUNTIME_OTHER)'''

# More precise replacement
content = content.replace(
    '''g_io_module_openssl_register ();
#endif

    if (runtime == FRIDA_RUNTIME_OTHER)''',
    new
)

with open(filepath, "w") as f:
    f.write(content)
print("  Patch 8 applied")
PATCH8

        # ===== Patch 9: memfd-name-jit-cache =====
        echo "[*] Applying patch 9: memfd-name-jit-cache"
        sed -i 's/return Linux.syscall (SysCall.memfd_create, name, flags);/return Linux.syscall (SysCall.memfd_create, "jit-cache", flags);/g' lib/base/linux.vala
        echo "  Patch 9 applied"
        
        # ===== Custom Patch: Hide socket names =====
        echo "[*] Applying custom patch: hide socket names"
        python3 << 'SOCKET_PATCH'
# Patch frida-helper-backend.vala
filepath = "src/linux/frida-helper-backend.vala"
with open(filepath, "r") as f:
    content = f.read()
old = 'return "/frida-" + Uuid.string_random ();'
new = 'var _b = new StringBuilder (); var _c = "abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789"; for (var _i = 0; _i != 32; _i++) _b.append_c (_c[Random.int_range (0, _c.length)]); return "/" + _b.str;'
if old in content:
    content = content.replace(old, new)
    with open(filepath, "w") as f:
        f.write(content)
    print("  Socket patch (backend) applied")
else:
    print("  Socket patch (backend) - pattern not found, skipping")

# Patch frida-helper-process.vala
filepath = "src/linux/frida-helper-process.vala"
with open(filepath, "r") as f:
    content = f.read()
old = 'string socket_path = "/frida-" + Uuid.string_random ();'
new = 'var _b = new StringBuilder (); var _c = "abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789"; for (var _i = 0; _i != 32; _i++) _b.append_c (_c[Random.int_range (0, _c.length)]); string socket_path = "/" + _b.str;'
if old in content:
    content = content.replace(old, new)
    with open(filepath, "w") as f:
        f.write(content)
    print("  Socket patch (process) applied")
else:
    print("  Socket patch (process) - pattern not found, skipping")

# Patch system.vala
filepath = "src/system.vala"
with open(filepath, "r") as f:
    content = f.read()
content = content.replace('new StringBuilder ("frida-")', 'new StringBuilder ()')
content = content.replace('for (var i = 0; i != 16; i++)', 'for (var i = 0; i != 32; i++)')
content = content.replace('builder.append_printf ("%02x", Random.int_range (0, 256))', 'builder.append_c ("abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789"[Random.int_range (0, 62)])')
with open(filepath, "w") as f:
    f.write(content)
print("  Socket patch (system) applied")
SOCKET_PATCH

        # ===== Create anti-anti-frida.py script =====
        echo "[*] Creating anti-anti-frida.py"
        cat > src/anti-anti-frida.py << 'ANTIFRIDA'
import lief
import sys
import random
import os
 
def log_color(msg):
    print(f"\033[1;31;40m{msg}\033[0m")
 
if __name__ == "__main__":
    input_file = sys.argv[1]
    random_charset = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz"
    log_color(f"[*] Patch frida-agent: {input_file}")
    binary = lief.parse(input_file)
 
    if not binary:
        log_color(f"[*] Not elf, exit")
        exit()
    
    random_name = "".join(random.sample(random_charset, 5))
    log_color(f"[*] Patch `frida` to `{random_name}`")

    for symbol in binary.symbols:
        if symbol.name == "frida_agent_main":
            symbol.name = "main"
 
        if "frida" in symbol.name:
            symbol.name = symbol.name.replace("frida", random_name)
 
        if "FRIDA" in symbol.name:
            symbol.name = symbol.name.replace("FRIDA", random_name)
 
    all_patch_string = ["FridaScriptEngine", "GLib-GIO", "GDBusProxy", "GumScript"]
    for section in binary.sections:
        if section.name != ".rodata":
            continue
        for patch_str in all_patch_string:
            addr_all = section.search_all(patch_str)
            for addr in addr_all:
                patch = [ord(n) for n in list(patch_str)[::-1]]
                log_color(f"[*] Patching section name={section.name} offset={hex(section.file_offset + addr)} orig:{patch_str} new:{''.join(list(patch_str)[::-1])}")
                binary.patch_address(section.file_offset + addr, patch)
 
    binary.write(input_file)
 
    # thread_gum_js_loop
    random_name = "".join(random.sample(random_charset, 11))
    log_color(f"[*] Patch `gum-js-loop` to `{random_name}`")
    os.system(f"sed -b -i s/gum-js-loop/{random_name}/g {input_file}")
 
    # thread_gmain
    random_name = "".join(random.sample(random_charset, 5))
    log_color(f"[*] Patch `gmain` to `{random_name}`")
    os.system(f"sed -b -i s/gmain/{random_name}/g {input_file}")
 
    # thread_gdbus
    random_name = "".join(random.sample(random_charset, 5))
    log_color(f"[*] Patch `gdbus` to `{random_name}`")
    os.system(f"sed -b -i s/gdbus/{random_name}/g {input_file}")

    log_color(f"[*] Patch Finish")
ANTIFRIDA

        # ===== Patch 10: exec anti-anti-frida.py in embed-agent.py =====
        echo "[*] Applying patch 10: exec anti-anti-frida.py"
        python3 << 'PATCH10'
filepath = "src/embed-agent.py"
with open(filepath, "r") as f:
    content = f.read()

# Find the location to insert anti-anti-frida call
old_pattern = '''else:
                embedded_agent.write_bytes(b"")
            embedded_assets += [embedded_agent]'''

new_pattern = '''else:
                embedded_agent.write_bytes(b"")
            import os
            custom_script=str(output_dir)+"/../../../../frida/subprojects/frida-core/src/anti-anti-frida.py"
            return_code = os.system("python3 "+custom_script+" "+str(priv_dir / f"frida-agent-{flavor}.so"))
            if return_code == 0:
                print("anti-anti-frida finished")
            else:
                print("anti-anti-frida error. Code:", return_code)
            
            embedded_assets += [embedded_agent]'''

content = content.replace(old_pattern, new_pattern)

with open(filepath, "w") as f:
    f.write(content)
print("  Patch 10 applied")
PATCH10

        echo "[*] All frida-core patches applied!"

    - name: Apply Florida Patches - frida-gum
      run: |
        cd frida/subprojects/frida-gum
        
        # ===== Patch: pool-frida in gum.c =====
        echo "[*] Applying frida-gum patch: pool-frida"
        sed -i 's/g_set_prgname ("frida");/g_set_prgname ("ggbond");/g' gum/gum.c
        echo "  frida-gum patch applied!"

    - name: Setup Android NDK
      uses: nttld/setup-ndk@v1
      id: setup-ndk
      with:
        ndk-version: r25c
        
    - name: Build frida-server for Android arm64
      run: |
        cd frida
        export ANDROID_NDK_ROOT=${{ steps.setup-ndk.outputs.ndk-path }}
        make core-android-arm64
      env:
        FRIDA_VERSION: 16.7.19

    - name: Compress artifact
      run: |
        cd frida/build/frida-android-arm64/bin
        gzip -k frida-server
        mv frida-server.gz frida-server-16.7.19-florida-android-arm64.gz
        
    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: frida-server-16.7.19-florida-android-arm64
        path: frida/build/frida-android-arm64/bin/frida-server-16.7.19-florida-android-arm64.gz
