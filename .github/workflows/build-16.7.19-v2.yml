name: Build Florida 16.7.19 v2

on:
  workflow_dispatch:

jobs:
  android_build:
    runs-on: ubuntu-22.04

    steps:
    - uses: actions/checkout@v3

    - uses: actions/setup-node@v3
      with:
        node-version: 18

    - name: Set up JDK 17
      uses: actions/setup-java@v3
      with:
        distribution: "temurin"
        java-version: "17"

    - name: Setup Android NDK
      id: setup-ndk
      uses: nttld/setup-ndk@v1
      with:
        ndk-version: r25c
        local-cache: false
        link-to-sdk: true

    - name: Set up Python 3.9
      uses: actions/setup-python@v4
      with:
        python-version: 3.9

    - name: install dependencies
      run: |
        sudo apt-get update && DEBIAN_FRONTEND=noninteractive sudo apt-get install build-essential tree ninja-build gcc-multilib g++-multilib lib32stdc++-9-dev flex bison ruby ruby-dev python3-requests python3-setuptools python3-dev python3-pip libc6-dev libc6-dev-i386 -y
        sudo gem install fpm -v 1.11.0 --no-document
        python3 -m pip install lief graphlib

    - name: build frida 16.7.19 for Android
      shell: bash
      run: |
        git config --global user.name "GitHub Actions"
        git config --global user.email "41898282+github-actions[bot]@users.noreply.github.com"
        
        export ANDROID_NDK_ROOT=${{ steps.setup-ndk.outputs.ndk-path }}
        echo "ANDROID_NDK_ROOT=$ANDROID_NDK_ROOT"
        
        # Clone frida 16.7.19
        git clone --recurse-submodules --branch 16.7.19 https://github.com/frida/frida
        
        echo "=== Patching socket names ==="
        
        BACKEND_FILE="frida/subprojects/frida-core/src/linux/frida-helper-backend.vala"
        PROCESS_FILE="frida/subprojects/frida-core/src/linux/frida-helper-process.vala"
        SYSTEM_FILE="frida/subprojects/frida-core/src/system.vala"
        
        # Show original lines before patching
        echo "=== Original code ==="
        echo "--- backend.vala:1254-1256 ---"
        sed -n '1254,1256p' "$BACKEND_FILE"
        echo "--- process.vala:323-325 ---"
        sed -n '323,325p' "$PROCESS_FILE"
        echo "--- system.vala:240-244 ---"
        sed -n '240,244p' "$SYSTEM_FILE"
        
        # Use Python for reliable patching
        cat > /tmp/patch_frida.py << 'PYEOF'
import sys

backend_file = "frida/subprojects/frida-core/src/linux/frida-helper-backend.vala"
process_file = "frida/subprojects/frida-core/src/linux/frida-helper-process.vala"
system_file = "frida/subprojects/frida-core/src/system.vala"

# Patch 1: backend
with open(backend_file, 'r') as f:
    content = f.read()
old = 'return "/frida-" + Uuid.string_random ();'
new = 'var _sb = new StringBuilder (); var _c = "abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789"; for (var _i = 0; _i != 32; _i++) _sb.append_c (_c[Random.int_range (0, _c.length)]); return "/" + _sb.str;'
if old in content:
    content = content.replace(old, new)
    with open(backend_file, 'w') as f:
        f.write(content)
    print("OK: Patched backend")
else:
    print("FAIL: backend pattern not found")
    sys.exit(1)

# Patch 2: process
with open(process_file, 'r') as f:
    content = f.read()
old = 'string socket_path = "/frida-" + Uuid.string_random ();'
new = 'var _sb = new StringBuilder (); var _c = "abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789"; for (var _i = 0; _i != 32; _i++) _sb.append_c (_c[Random.int_range (0, _c.length)]); string socket_path = "/" + _sb.str;'
if old in content:
    content = content.replace(old, new)
    with open(process_file, 'w') as f:
        f.write(content)
    print("OK: Patched process")
else:
    print("FAIL: process pattern not found")
    sys.exit(1)

# Patch 3: system - use simple single-line replacement
with open(system_file, 'r') as f:
    content = f.read()
# Just replace the key parts
old1 = 'new StringBuilder ("frida-")'
new1 = 'new StringBuilder ()'
old2 = 'for (var i = 0; i != 16; i++)'
new2 = 'for (var i = 0; i != 32; i++)'
old3 = 'builder.append_printf ("%02x", Random.int_range (0, 256))'
new3 = 'builder.append_c ("abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789"[Random.int_range (0, 62)])'

patched = False
if old1 in content:
    content = content.replace(old1, new1)
    patched = True
    print("OK: Patched StringBuilder")
if old2 in content:
    content = content.replace(old2, new2)
    print("OK: Patched loop count")
if old3 in content:
    content = content.replace(old3, new3)
    print("OK: Patched append")

if patched:
    with open(system_file, 'w') as f:
        f.write(content)
    print("OK: Patched system")
else:
    print("FAIL: system patterns not found")
    sys.exit(1)

print("All patches applied successfully!")
PYEOF
        python3 /tmp/patch_frida.py
        
        # Verify patches were applied
        echo ""
        echo "=== After patching ==="
        echo "--- backend.vala:1254-1260 ---"
        sed -n '1254,1260p' "$BACKEND_FILE"
        echo "--- process.vala:323-329 ---"
        sed -n '323,329p' "$PROCESS_FILE"
        echo "--- system.vala:240-246 ---"
        sed -n '240,246p' "$SYSTEM_FILE"
        
        # Final verification
        echo ""
        echo "=== Final grep check ==="
        echo -n "backend.vala frida- count: "
        grep -c '"/frida-"' "$BACKEND_FILE" || echo "0"
        echo -n "process.vala frida- count: "
        grep -c '"/frida-"' "$PROCESS_FILE" || echo "0"
        echo -n "system.vala frida- prefix count: "
        grep -c 'StringBuilder ("frida-")' "$SYSTEM_FILE" || echo "0"
        
        # Build only arm64
        mkdir build-android-arm64
        cd build-android-arm64
        ../frida/configure --host=android-arm64
        make

    - name: package and upload
      shell: bash
      run: |
        gzip -k build-android-arm64/subprojects/frida-core/server/frida-server
        mv build-android-arm64/subprojects/frida-core/server/frida-server.gz florida-server-16.7.19-patched-android-arm64.gz

    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: florida-16.7.19-patched-arm64
        path: florida-server-16.7.19-patched-android-arm64.gz
